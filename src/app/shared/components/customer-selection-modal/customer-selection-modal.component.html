<div *ngIf="isOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden">
        <!-- Header -->
        <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-xl font-bold text-navy dark:text-white">
                {{ currentView === 'new-customer' ? 'New Customer' : 'Select Customer' }}
            </h2>
            <button (click)="onClose()" class="text-gray-400 hover:text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- New Customer Form View -->
            <form *ngIf="currentView === 'new-customer'" [formGroup]="newCustomerForm"
                (ngSubmit)="onSubmitNewCustomer()" class="space-y-6">
                <!-- Error Alert Removed - Using Toasts -->

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name
                            *</label>
                        <input formControlName="name" type="text"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="Enter customer name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">National ID
                            *</label>
                        <input formControlName="nationalId" type="text"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="14 digits" required>
                    </div>
                    <div>
                        <app-date-picker formControlName="dateOfBirth" label="Date of Birth"></app-date-picker>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gender</label>
                        <select formControlName="gender"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address
                            *</label>
                        <input formControlName="email" type="email"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="customer@example.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone Number
                            *</label>
                        <input formControlName="phone" type="tel"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="01012345678" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Street</label>
                        <input formControlName="street" type="text"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="Street address">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City</label>
                        <input formControlName="city" type="text"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            placeholder="City">
                    </div>
                </div>

                <div class="flex justify-between pt-4">
                    <button type="button" (click)="onBack()"
                        class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Back</button>
                    <button type="submit" [disabled]="loading || newCustomerForm.invalid"
                        class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        {{ loading ? 'Creating...' : 'Continue' }}
                    </button>
                </div>
            </form>

            <!-- Select Existing Customer View -->
            <div *ngIf="currentView === 'select-customer'" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Existing
                        Customer</label>

                    <!-- Search Filters -->
                    <div class="mb-4 space-y-3">
                        <!-- Customer Type Radio -->
                        <div class="flex items-center gap-6">
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio text-primary" name="customerType"
                                    value="individual" [(ngModel)]="searchCustomerType"
                                    (change)="searchIsForeign = false">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Individual</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio text-primary" name="customerType" value="company"
                                    [(ngModel)]="searchCustomerType" (change)="searchIsForeign = false">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Company</span>
                            </label>
                        </div>

                        <!-- Foreign Customer Toggle (Only for Individual) -->
                        <div *ngIf="searchCustomerType === 'individual'" class="flex items-center">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" [(ngModel)]="searchIsForeign" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                                </div>
                                <span class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Is Foreign
                                    Customer?</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input [(ngModel)]="searchQuery" (keyup.enter)="onSearch()" type="text"
                            class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            [placeholder]="searchPlaceholder">
                        <button type="button" (click)="onSearch()" [disabled]="loading"
                            class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors disabled:opacity-50">
                            {{ loading ? 'Searching...' : 'Search' }}
                        </button>
                    </div>
                </div>

                <!-- Error Alert Removed - Using Toasts -->

                <!-- Search Results -->
                <div *ngIf="searchResults.length > 0" class="space-y-3 max-h-60 overflow-y-auto">
                    <div *ngFor="let customer of searchResults"
                        class="border-2 rounded-xl p-4 cursor-pointer flex items-center gap-4 transition-all"
                        [ngClass]="{'border-primary bg-blue-50': selectedCustomer?.national_id === customer.national_id, 'border-gray-200 hover:border-gray-300': selectedCustomer?.national_id !== customer.national_id}"
                        (click)="onSelectExistingCustomer(customer)">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center"
                            [ngClass]="{'bg-primary text-white': selectedCustomer?.national_id === customer.national_id, 'bg-gray-100': selectedCustomer?.national_id !== customer.national_id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-navy dark:text-white text-base">{{ customer.english_name ||
                                    customer.arabic_name }}</h3>
                                <span *ngIf="customer.national_id"
                                    class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-md font-medium border border-blue-100">
                                    ID: {{ customer.national_id }}
                                </span>
                            </div>
                            <div
                                class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1.5 text-sm text-gray-600 dark:text-gray-300">
                                <div *ngIf="customer.email" class="flex items-center gap-1.5 text-xs truncate">
                                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="truncate">{{ customer.email }}</span>
                                </div>
                                <div *ngIf="customer.phone || customer.mobile"
                                    class="flex items-center gap-1.5 text-xs">
                                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                        </path>
                                    </svg>
                                    <span>{{ customer.phone || customer.mobile }}</span>
                                </div>
                                <div *ngIf="customer.date_of_birth" class="flex items-center gap-1.5 text-xs">
                                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span>{{ customer.date_of_birth }}</span>
                                </div>
                                <div *ngIf="customer.city || customer.state_name || customer.country_name"
                                    class="flex items-center gap-1.5 text-xs col-span-1 sm:col-span-2 truncate">
                                    <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="truncate">{{ customer.city }}{{ customer.state_name ? ', ' +
                                        customer.state_name : '' }}{{ customer.country_name ? ', ' +
                                        customer.country_name : '' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create New Customer Card (Show if search has been performed and no results, OR if search is empty/not performed yet but we want to offer the option) -->
                <!-- Per user request: "if not exist Show Create customer card" -> implies when search returns nothing. 
                     However, for better UX, we might want to show it if search results are empty after search.
                -->
                <div *ngIf="hasSearched && searchResults.length === 0 && !loading"
                    class="animate-fade-in text-center py-4">
                    <div class="mb-4 text-gray-500">
                        <p class="text-base font-medium">Customer not found</p>
                        <p class="text-sm">We couldn't find a customer matching "{{ searchQuery }}"</p>
                    </div>

                    <div class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:border-green-500 border-dashed border-gray-300 bg-gray-50 hover:bg-green-50 group"
                        (click)="onSelectType('new')">
                        <div class="flex items-center gap-4 justify-center">
                            <div
                                class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-200 text-gray-500 group-hover:bg-green-500 group-hover:text-white transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                                    </path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-700 group-hover:text-green-800 text-base">Create New
                                    Customer</h3>
                                <p class="text-xs text-gray-500 group-hover:text-green-700">Add a new customer profile
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between pt-4 border-t border-gray-100 dark:border-gray-700">
                    <!-- Only show Back if we are not in the main select view, OR if we want to allow closing. 
                        The header close button handles closing. This back button might be redundant or could just close.
                        User might expect 'Back' to go to previous step, but this IS the first step now. 
                        Let's keep it as a Close/Cancel button.
                   -->
                    <button type="button" (click)="onClose()"
                        class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
                    <button type="button" (click)="onConfirmSelection()" [disabled]="!selectedCustomer"
                        class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Continue
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>