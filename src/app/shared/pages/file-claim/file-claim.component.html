<app-dashboard-layout>
    <div *ngIf="!isComplete; else successView">

        <!-- Wizard Section -->
        <div class="max-w-7xl mx-auto">
            <app-wizard #wizard [title]="'CLAIMS.NEW_INTIMATION.TITLE' | translate" [steps]="steps"
                [initialData]="formData" (complete)="onWizardComplete($event)">

                <ng-container *ngIf="wizard.currentStep === 0">
                    <!-- Step 1: Customer & Policy Info -->
                    <div class="space-y-6">
                        <div
                            class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800 flex items-start gap-3">
                            <i-lucide name="info" class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5"></i-lucide>
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                {{ 'CLAIMS.NEW_INTIMATION.VERIFY_INFO' | translate }}
                            </p>
                        </div>

                        <app-collapsible-section [title]="'CLAIMS.NEW_INTIMATION.CUSTOMER_POLICY_INFO' | translate"
                            [expanded]="isCustomerInfoExpanded"
                            (toggle)="isCustomerInfoExpanded = !isCustomerInfoExpanded">
                            <div class="p-4 space-y-6">
                                <!-- Customer Details Section -->
                                <div>
                                    <h4
                                        class="text-md font-semibold text-navy dark:text-white mb-4 flex items-center gap-2 border-b pb-2 border-gray-100 dark:border-gray-700">
                                        <i-lucide name="user" class="w-4 h-4"></i-lucide>
                                        Customer Details
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-y-4 gap-x-6 text-sm">
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.NAME' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                customerInfo?.customer_name || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.PHONE' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                customerInfo?.customer_phone_number || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.EMAIL' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                customerInfo?.customer_email || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.GENDER' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200 capitalize">{{
                                                customerInfo?.customer_gender || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.BIRTH_DATE' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                customerInfo?.customer_birth_date || 'N/A' }}</span>
                                        </div>
                                        <div class="md:col-span-2 lg:col-span-3">
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.ADDRESS' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                customerInfo?.customer_address || 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Policy/Risk Section -->
                                <div>
                                    <h4
                                        class="text-md font-semibold text-navy dark:text-white mb-4 flex items-center gap-2 border-b pb-2 border-gray-100 dark:border-gray-700">
                                        <i-lucide name="car" class="w-4 h-4"></i-lucide>
                                        {{ 'CLAIMS.NEW_INTIMATION.VEHICLE_INFO' | translate }}
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-y-4 gap-x-6 text-sm">
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.PLATE_NUMBER' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vehicle_plate_number || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.MAKER' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vehicle_maker || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.MODEL' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vehcile_model || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.CATEGORY' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vechicle_category || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.ENGINE_CAPACITY' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vechicle_engine_capacity || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.MFG_YEAR' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vehicle_manufacturing_year || 'N/A' }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.CHASSIS_NUMBER' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200 font-mono">{{
                                                riskInfo?.vechicle_chassis_number || formData.chassis_number || 'N/A'
                                                }}</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-500 text-xs uppercase tracking-wider">{{
                                                'CLAIMS.NEW_INTIMATION.MOTOR_NUMBER' | translate }}</span>
                                            <span class="font-medium text-gray-800 dark:text-gray-200">{{
                                                riskInfo?.vehicle_motor_number || 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </app-collapsible-section>

                        <form #step0Form="ngForm" class="space-y-6">
                            <!-- Accident Information Collapsible (Moved from Step 1) -->
                            <app-collapsible-section [title]="'CLAIMS.NEW_INTIMATION.ACCIDENT_INFO' | translate"
                                [expanded]="isAccidentInfoExpanded"
                                (toggle)="isAccidentInfoExpanded = !isAccidentInfoExpanded"
                                [isComplete]="!!formData.loss_date && !!formData.requested_survey_date && !!formData.severity">
                                <div class="p-4 space-y-4">
                                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <app-text-input [label]="'CLAIMS.NEW_INTIMATION.LOSS_DATE' | translate"
                                                type="date" [(ngModel)]="formData.loss_date" name="loss_date_view"
                                                icon="calendar"></app-text-input>
                                            <app-text-input
                                                [label]="'CLAIMS.NEW_INTIMATION.INTIMATION_DATE' | translate"
                                                type="date" [(ngModel)]="formData.intimation_date"
                                                name="intimation_date" [disabled]="true"
                                                icon="calendar"></app-text-input>

                                            <app-text-input
                                                [label]="'CLAIMS.NEW_INTIMATION.POLICE_REPORT_NUMBER' | translate"
                                                [(ngModel)]="formData.police_report_number" name="police_report_number"
                                                [placeholder]="'CLAIMS.NEW_INTIMATION.POLICE_REPORT_NUMBER' | translate"
                                                icon="file-text"></app-text-input>

                                            <div class="md:col-span-1">
                                                <app-selection-modal
                                                    [label]="'CLAIMS.NEW_INTIMATION.SEVERITY' | translate"
                                                    [(value)]="formData.severity" name="severity"
                                                    [options]="severityOptions"
                                                    [title]="'CLAIMS.NEW_INTIMATION.SELECT_SEVERITY' | translate"
                                                    [subtitle]="'CLAIMS.NEW_INTIMATION.CHOOSE_SEVERITY' | translate"
                                                    [layout]="'list'" [required]="true"></app-selection-modal>
                                            </div>


                                            <app-text-input
                                                [label]="'CLAIMS.NEW_INTIMATION.REQUESTED_SURVEY_DATE' | translate"
                                                type="date" [(ngModel)]="formData.requested_survey_date"
                                                name="requested_survey_date" [required]="true" [min]="minSurveyDate"
                                                icon="calendar"></app-text-input>
                                        </div>
                                    </div>
                                </div>
                            </app-collapsible-section>

                            <!-- Workshop Information Collapsible -->
                            <app-collapsible-section [title]="'CLAIMS.NEW_INTIMATION.WORKSHOP_INFO' | translate"
                                [expanded]="isWorkshopInfoExpanded"
                                (toggle)="isWorkshopInfoExpanded = !isWorkshopInfoExpanded"
                                [isComplete]="!!formData.workshop_type && (formData.workshop_type === 'internal' ? !!formData.internal_workshop_code : (!!formData.workshop_address && !!formData.workshop_number))">
                                <div class="p-4 space-y-4">
                                    <!-- Workshop Information Form -->
                                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="md:col-span-2">
                                                <app-selection-modal
                                                    [label]="'CLAIMS.NEW_INTIMATION.WORKSHOP_TYPE' | translate"
                                                    [(value)]="formData.workshop_type" name="workshop_type"
                                                    [options]="workshopTypeOptions"
                                                    [title]="'CLAIMS.NEW_INTIMATION.SELECT_WORKSHOP_TYPE' | translate"
                                                    [subtitle]="'CLAIMS.NEW_INTIMATION.CHOOSE_WORKSHOP_TYPE' | translate"
                                                    [layout]="'list'" [required]="true"></app-selection-modal>
                                            </div>

                                            <ng-container *ngIf="formData.workshop_type === 'internal'">
                                                <div class="md:col-span-2">
                                                    <app-selection-modal
                                                        [label]="'CLAIMS.NEW_INTIMATION.INTERNAL_WORKSHOP' | translate"
                                                        [(value)]="formData.internal_workshop_code"
                                                        name="internal_workshop_code"
                                                        [options]="internalWorkshopOptions"
                                                        [title]="'CLAIMS.NEW_INTIMATION.SELECT_WORKSHOP' | translate"
                                                        [subtitle]="'CLAIMS.NEW_INTIMATION.SEARCH_WORKSHOP' | translate"
                                                        [enableSearch]="true" [required]="true" displayKey="name"
                                                        valueKey="code" descriptionKey="description"
                                                        (search)="onWorkshopSearch($event)"></app-selection-modal>
                                                </div>
                                            </ng-container>

                                            <ng-container *ngIf="formData.workshop_type === 'external'">
                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.WORKSHOP_ADDRESS' | translate"
                                                    [(ngModel)]="formData.workshop_address" name="workshop_address"
                                                    [placeholder]="'CLAIMS.NEW_INTIMATION.WORKSHOP_ADDRESS' | translate"
                                                    [required]="true" icon="map-pin"></app-text-input>
                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.WORKSHOP_NUMBER' | translate"
                                                    [(ngModel)]="formData.workshop_number" name="workshop_number"
                                                    [placeholder]="'CLAIMS.NEW_INTIMATION.WORKSHOP_NUMBER' | translate"
                                                    [required]="true"></app-text-input>
                                            </ng-container>
                                        </div>
                                    </div>
                                </div>
                            </app-collapsible-section>

                            <!-- Intimator Details Collapsible -->
                            <app-collapsible-section [title]="'CLAIMS.NEW_INTIMATION.INTIMATOR_INFO' | translate"
                                [expanded]="isIntimatorInfoExpanded"
                                (toggle)="isIntimatorInfoExpanded = !isIntimatorInfoExpanded"
                                [isComplete]="formData.is_insured || (formData.intimator_name && formData.intimator_phone)">
                                <div class="p-4 space-y-4">
                                    <!-- Is Insured Toggle -->
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-900 dark:text-gray-300">{{
                                            'CLAIMS.NEW_INTIMATION.ARE_YOU_INSURED' | translate }}</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" [(ngModel)]="formData.is_insured" name="is_insured"
                                                (change)="onInsuredToggle()" class="sr-only peer">
                                            <div
                                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary">
                                            </div>
                                        </label>
                                    </div>

                                    <!-- Intimator Details Form -->
                                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg"
                                        *ngIf="!formData.is_insured">
                                        <h3 class="text-lg font-semibold text-navy dark:text-white mb-4">{{
                                            'CLAIMS.NEW_INTIMATION.INTIMATOR_DETAILS' | translate }}</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <app-text-input [label]="'CLAIMS.NEW_INTIMATION.INTIMATOR_NAME' | translate"
                                                [(ngModel)]="formData.intimator_name" name="intimator_name"
                                                [required]="true"></app-text-input>
                                            <app-text-input
                                                [label]="'CLAIMS.NEW_INTIMATION.INTIMATOR_PHONE' | translate"
                                                [(ngModel)]="formData.intimator_phone" name="intimator_phone"
                                                [required]="true"></app-text-input>
                                            <div class="md:col-span-2">
                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.INTIMATOR_ADDRESS' | translate"
                                                    [(ngModel)]="formData.intimator_address" name="intimator_address"
                                                    [required]="true"></app-text-input>
                                            </div>
                                            <app-text-input [label]="'CLAIMS.NEW_INTIMATION.RELATIONSHIP' | translate"
                                                [(ngModel)]="formData.relative" name="relative"
                                                placeholder="Self, Driver, etc."></app-text-input>
                                        </div>
                                    </div>
                                </div>
                            </app-collapsible-section>

                            <!-- Driver Information Collapsible -->
                            <app-collapsible-section [title]="'CLAIMS.NEW_INTIMATION.DRIVER_INFO' | translate"
                                [expanded]="isDriverInfoExpanded"
                                (toggle)="isDriverInfoExpanded = !isDriverInfoExpanded"
                                [isComplete]="formData.is_driver || (formData.driver_name && formData.driver_birth_date)">
                                <div class="p-4 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-900 dark:text-gray-300">{{
                                            'CLAIMS.NEW_INTIMATION.I_WAS_DRIVER' | translate }}</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" [(ngModel)]="formData.is_driver" name="is_driver"
                                                (change)="onDriverToggle()" class="sr-only peer">
                                            <div
                                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary">
                                            </div>
                                        </label>
                                    </div>

                                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg"
                                        *ngIf="!formData.is_driver">
                                        <h3 class="text-lg font-semibold text-navy dark:text-white mb-4">{{
                                            'CLAIMS.NEW_INTIMATION.DRIVER_DETAILS' | translate }}</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                            <ng-container>
                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.DRIVER_NAME' | translate"
                                                    [(ngModel)]="formData.driver_name" name="driver_name"
                                                    [placeholder]="'CLAIMS.NEW_INTIMATION.DRIVER_NAME' | translate"
                                                    [required]="true" icon="user"></app-text-input>
                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.DRIVER_BIRTH_DATE' | translate"
                                                    type="date" [(ngModel)]="formData.driver_birth_date"
                                                    name="driver_birth_date" icon="calendar"></app-text-input>

                                                <div>
                                                    <app-selection-modal
                                                        [label]="'CLAIMS.NEW_INTIMATION.DRIVER_GENDER' | translate"
                                                        [(value)]="formData.driver_gender" name="driver_gender"
                                                        [options]="genderOptions"
                                                        [title]="'CLAIMS.NEW_INTIMATION.SELECT_GENDER' | translate"
                                                        [layout]="'list'"></app-selection-modal>
                                                </div>

                                                <div>
                                                    <app-selection-modal
                                                        [label]="'CLAIMS.NEW_INTIMATION.LICENSE_TYPE' | translate"
                                                        [value]="formData.driver_license_type"
                                                        (valueChange)="onDriverLicenseTypeChange($event)"
                                                        name="driver_license_type" [options]="licenseTypeOptions"
                                                        [title]="'CLAIMS.NEW_INTIMATION.SELECT_LICENSE_TYPE' | translate"
                                                        [layout]="'list'" [required]="true"></app-selection-modal>
                                                </div>

                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.LICENSE_START_DATE' | translate"
                                                    type="date" [(ngModel)]="formData.driver_licence_start_date"
                                                    (ngModelChange)="calculateDriverLicenseExpiration()"
                                                    name="driver_licence_start_date" icon="calendar"></app-text-input>
                                                <app-text-input
                                                    [label]="'CLAIMS.NEW_INTIMATION.LICENSE_EXPIRY_DATE' | translate"
                                                    type="date" [(ngModel)]="formData.driver_licence_expiration_date"
                                                    name="driver_licence_expiration_date"
                                                    icon="calendar"></app-text-input>
                                            </ng-container>

                                            <!-- Driver License Upload -->
                                            <div *ngIf="driverLicenseDoc"
                                                class="mt-4 border-t pt-4 border-gray-100 dark:border-gray-700 md:col-span-2">
                                                <h4 class="text-sm font-medium text-navy dark:text-white mb-2">{{
                                                    driverLicenseDoc.name || driverLicenseDoc.item ||
                                                    driverLicenseDoc.label }}</h4>
                                                <app-file-upload
                                                    (filesSelected)="onFileSelectForDoc($event, driverLicenseDoc)"
                                                    [multiple]="false">
                                                </app-file-upload>
                                                <div *ngIf="uploadedFiles[driverLicenseDoc.id || driverLicenseDoc.name]?.length"
                                                    class="mt-2 text-xs text-green-600">
                                                    <i-lucide name="check" class="w-3 h-3 inline mr-1"></i-lucide>
                                                    {{ 'CLAIMS.NEW_INTIMATION.ATTACHED' | translate }}
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </app-collapsible-section>

                            <!-- Car License Information Collapsible (Editable) -->
                            <app-collapsible-section [title]="'CLAIMS.NEW_INTIMATION.CAR_LICENSE_INFO' | translate"
                                [expanded]="isCarLicenseInfoExpanded"
                                (toggle)="isCarLicenseInfoExpanded = !isCarLicenseInfoExpanded"
                                [isComplete]="!!formData.vehicle_licence_start_date && !!formData.vehicle_licence_expiration_date">
                                <div class="p-4 space-y-4">
                                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <app-text-input
                                                [label]="'CLAIMS.NEW_INTIMATION.LICENSE_START_DATE' | translate"
                                                type="date" [(ngModel)]="formData.vehicle_licence_start_date"
                                                (ngModelChange)="calculateVehicleLicenseExpiration()"
                                                name="vehicle_licence_start_date" icon="calendar"></app-text-input>
                                            <app-text-input
                                                [label]="'CLAIMS.NEW_INTIMATION.LICENSE_EXPIRY_DATE' | translate"
                                                type="date" [(ngModel)]="formData.vehicle_licence_expiration_date"
                                                name="vehicle_licence_expiration_date" icon="calendar"></app-text-input>
                                        </div>

                                        <!-- Car License Upload -->
                                        <div *ngIf="carLicenseDoc"
                                            class="mt-4 border-t pt-4 border-gray-100 dark:border-gray-700">
                                            <h4 class="text-sm font-medium text-navy dark:text-white mb-2">{{
                                                carLicenseDoc.name || carLicenseDoc.item || carLicenseDoc.label }}</h4>
                                            <app-file-upload (filesSelected)="onFileSelectForDoc($event, carLicenseDoc)"
                                                [multiple]="false">
                                            </app-file-upload>
                                            <div *ngIf="uploadedFiles[carLicenseDoc.id || carLicenseDoc.name]?.length"
                                                class="mt-2 text-xs text-green-600">
                                                <i-lucide name="check" class="w-3 h-3 inline mr-1"></i-lucide>
                                                {{ 'CLAIMS.NEW_INTIMATION.ATTACHED' | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </app-collapsible-section>

                            <div class="flex justify-end">
                                <button type="button" (click)="wizard.handleNext(formData)"
                                    [disabled]="!step0Form.valid"
                                    class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                    {{ 'CLAIMS.NEW_INTIMATION.NEXT_STEP' | translate }}
                                </button>
                            </div>
                        </form>
                    </div>
                </ng-container>

                <ng-container *ngIf="wizard.currentStep === 1">
                    <!-- Step 2: Loss & Accident Details -->
                    <form #step2Form="ngForm" class="space-y-6">

                        <div class="grid grid-cols-1 gap-6">

                            <!-- Car Damage Visual Selector -->
                            <div class="w-full">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{
                                    'CLAIMS.NEW_INTIMATION.MARK_DAMAGED_PARTS' | translate }}</label>
                                <app-car-damage-selector (partsSelected)="onPartsSelected($event)">
                                </app-car-damage-selector>
                            </div>

                            <div class="md:col-span-2">
                                <app-textarea-input [label]="'CLAIMS.NEW_INTIMATION.INITIAL_DAMAGE_DESC' | translate"
                                    [(ngModel)]="formData.initial_damage_description" name="initial_damage_description"
                                    [placeholder]="'CLAIMS.NEW_INTIMATION.DESCRIBE_DAMAGE' | translate"
                                    [required]="true"></app-textarea-input>
                            </div>

                            <div class="md:col-span-2">
                                <app-textarea-input [label]="'CLAIMS.NEW_INTIMATION.ACCIDENT_DESC' | translate"
                                    [(ngModel)]="formData.acc_desc" name="acc_desc"
                                    [placeholder]="'CLAIMS.NEW_INTIMATION.DESCRIBE_ACCIDENT' | translate"
                                    [required]="true"></app-textarea-input>
                            </div>

                            <div class="md:col-span-2">
                                <app-text-input [label]="'CLAIMS.NEW_INTIMATION.ACCIDENT_ADDRESS' | translate"
                                    [(ngModel)]="formData.accident_address" name="accident_address"
                                    [placeholder]="'CLAIMS.NEW_INTIMATION.ACCIDENT_ADDRESS' | translate"
                                    [required]="true" icon="map-pin"></app-text-input>
                            </div>
                        </div>

                        <div class="flex justify-between">
                            <button type="button" (click)="wizard.handleBack()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Back
                            </button>
                            <button type="button" (click)="onLossDetailsNext()" [disabled]="!step2Form.valid"
                                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                {{ 'CLAIMS.NEW_INTIMATION.NEXT_STEP' | translate }}
                            </button>
                        </div>
                    </form>
                </ng-container>

                <ng-container *ngIf="wizard.currentStep === 2">
                    <!-- Step 4: Claim Documents -->
                    <form #step3Form="ngForm" class="space-y-6">
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-center text-navy dark:text-white mb-4">{{
                                'CLAIMS.NEW_INTIMATION.UPLOAD_DOCUMENTS' | translate }}</h3>
                            <p class="text-center text-gray-600 dark:text-gray-300 mb-6">{{
                                'CLAIMS.NEW_INTIMATION.UPLOAD_DESC' | translate }}</p>

                            <!-- Document List Iteration -->
                            <div class="space-y-6">
                                <ng-container *ngFor="let doc of generalDocuments">
                                    <div
                                        class="bg-white dark:bg-gray-800 p-4 rounded border border-gray-200 dark:border-gray-600">
                                        <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">
                                            {{ doc.name || doc.item || doc.label }} <span class="text-red-500">*</span>
                                        </h4>
                                        <app-file-upload [multiple]="true" [maxSize]="10485760"
                                            (filesSelected)="onFileSelectForDoc($event, doc)">
                                        </app-file-upload>

                                        <!-- Show selected files for this doc -->
                                        <div *ngIf="uploadedFiles[doc.id || doc.name]?.length" class="mt-2">
                                            <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-400">
                                                <li *ngFor="let file of uploadedFiles[doc.id || doc.name]">{{ file.name
                                                    }} ({{ (file.size / 1024).toFixed(1) }} KB)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </ng-container>

                                <div *ngIf="generalDocuments.length === 0" class="text-center text-gray-500 py-4">
                                    {{ 'CLAIMS.NEW_INTIMATION.NO_DOCS_REQUIRED' | translate }}
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between">
                            <button type="button" (click)="wizard.handleBack()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Back
                            </button>
                            <button type="button" (click)="wizard.handleNext(formData)"
                                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                {{ 'CLAIMS.NEW_INTIMATION.NEXT_STEP' | translate }}
                            </button>
                        </div>
                    </form>
                </ng-container>

                <ng-container *ngIf="wizard.currentStep === 3">
                    <!-- Step 5: Review & Submit -->
                    <div class="space-y-6">
                        <div
                            class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800">
                            <h3 class="text-lg font-semibold text-navy dark:text-white mb-2">{{
                                'CLAIMS.NEW_INTIMATION.REVIEW_DETAILS' | translate }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300">{{ 'CLAIMS.NEW_INTIMATION.REVIEW_DESC' |
                                translate }}</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                            <div><span class="font-semibold">{{ 'CLAIMS.NEW_INTIMATION.LOSS_DATE' | translate }}:</span>
                                {{ formData.loss_date }}</div>
                            <div><span class="font-semibold">{{ 'CLAIMS.NEW_INTIMATION.CHASSIS_NUMBER' | translate
                                    }}:</span> {{ formData.chassis_number }}</div>
                            <div><span class="font-semibold">{{ 'CLAIMS.NEW_INTIMATION.INTIMATOR_DETAILS' | translate
                                    }}:</span> {{ formData.intimator_name }}</div>
                            <div><span class="font-semibold">{{ 'CLAIMS.NEW_INTIMATION.DRIVER_DETAILS' | translate
                                    }}:</span> {{ formData.driver_name }}</div>
                            <div><span class="font-semibold">{{ 'CLAIMS.NEW_INTIMATION.VEHICLE_INFO' | translate
                                    }}:</span> {{ formData.vehicle_maker }} {{
                                formData.vehcile_model }} ({{ formData.vehicle_plate_number }})</div>
                            <!-- Add more summary fields as needed -->
                        </div>

                        <div class="flex justify-between mt-8">
                            <button type="button" (click)="wizard.handleBack()"
                                class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Back
                            </button>
                            <button type="button" (click)="wizard.handleNext(formData)"
                                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                {{ loading ? ('CLAIMS.NEW_INTIMATION.SUBMITTING' | translate) :
                                ('CLAIMS.NEW_INTIMATION.SUBMIT_CLAIM' | translate) }}
                            </button>
                        </div>
                    </div>
                </ng-container>

            </app-wizard>
        </div>

    </div>

    <!-- Success View -->
    <ng-template #successView>
        <div
            class="max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 text-center min-h-[400px] flex flex-col items-center justify-center">
            <div
                class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                <i-lucide name="check-circle" class="w-10 h-10 text-green-600 dark:text-green-400"></i-lucide>
            </div>

            <h2 class="text-2xl font-bold text-navy dark:text-white mb-2">{{ 'CLAIMS.NEW_INTIMATION.SUCCESS_TITLE' |
                translate }}</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-8">
                {{ 'CLAIMS.NEW_INTIMATION.SUCCESS_MSG' | translate }}
                <span *ngIf="claimId" class="block mt-2">{{ 'CLAIMS.NEW_INTIMATION.CLAIM_ID' | translate }}: <span
                        class="font-mono font-bold text-navy dark:text-white">{{ claimId }}</span></span>
            </p>

            <div *ngIf="submittedPolicyInfo"
                class="w-full max-w-2xl mx-auto bg-gray-50 dark:bg-gray-700/30 rounded-lg p-6 mb-8 text-left">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2">
                    {{ 'CLAIMS.NEW_INTIMATION.POLICY_DETAILS' | translate }}
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="block text-gray-500 text-xs text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.POLICY_NUMBER'
                            | translate }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.policy_number ||
                            'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.PLATE_NUMBER' |
                            translate }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.plate_number || 'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.CHASSIS_NUMBER' |
                            translate }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.chassis_number ||
                            'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.MOTOR_NUMBER' |
                            translate }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.motor_number || 'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.MAKER' | translate
                            }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.maker || 'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.MODEL' | translate
                            }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.model || 'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.CATEGORY' | translate
                            }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ submittedPolicyInfo.category || 'N/A'
                            }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">{{ 'CLAIMS.NEW_INTIMATION.SUM_INSURED' |
                            translate }}</span>
                        <span class="font-medium text-navy dark:text-white">{{ (submittedPolicyInfo.sum_insured |
                            currency)
                            || 'N/A' }}</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button (click)="viewClaims()"
                    class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    {{ 'CLAIMS.NEW_INTIMATION.VIEW_CLAIMS' | translate }}
                </button>
                <button (click)="goToDashboard()"
                    class="px-6 py-2 border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 transition-colors">
                    {{ 'CLAIMS.NEW_INTIMATION.GO_TO_DASHBOARD' | translate }}
                </button>
            </div>
        </div>
    </ng-template>
</app-dashboard-layout>